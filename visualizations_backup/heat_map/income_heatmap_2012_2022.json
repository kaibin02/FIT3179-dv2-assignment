{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "title": "Median Household Income - Heatmap (State x Year)",
  "width": {"step": 45},
  "height": {"step": 22},
  "data": {"url": "../income_2012-2022.csv"},
  "params": [
    {
      "name": "measureParam",
      "value": "Median (RM)",
      "bind": {"input": "select", "options": ["Median (RM)", "YoY %"]}
    },
    {
      "name": "yearParam",
      "value": 2022,
      "bind": {
        "input": "select",
        "options": [2012, 2014, 2016, 2019, 2020, 2022]
      }
    },
    {
      "name": "stateSelect",
      "select": {
        "type": "point",
        "fields": ["state"],
        "on": "click",
        "toggle": "event.shiftKey"
      }
    }
  ],
  "transform": [
    {
      "calculate": "toNumber(datum.date)",
      "as": "year"
    },
    {
      "sort": [{"field": "state"}, {"field": "year"}],
      "window": [
        {"op": "lag", "field": "income_median", "as": "lag_median"}
      ],
      "groupby": ["state"]
    },
    {
      "calculate": "datum.lag_median && datum.lag_median > 0 ? ((datum.income_median / datum.lag_median) - 1) * 100 : null",
      "as": "yoy_pct"
    },
    {
      "calculate": "datum.year == yearParam ? datum.income_median : null",
      "as": "sort_value"
    },
    {
      "aggregate": [{"op": "max", "field": "sort_value", "as": "sort_key"}],
      "groupby": ["state"]
    },
    {
      "calculate": "measureParam === 'Median (RM)' ? datum.income_median : datum.yoy_pct",
      "as": "display_value"
    }
  ],
  "mark": {"type": "rect"},
  "encoding": {
    "x": {
      "field": "year",
      "type": "ordinal",
      "title": "Year",
      "axis": {"labelAngle": -45}
    },
    "y": {
      "field": "state",
      "type": "nominal",
      "title": "State",
      "sort": {"field": "sort_key", "order": "descending"}
    },
    "color": {
      "field": "display_value",
      "type": "quantitative",
      "title": "Value",
      "scale": {
        "scheme": "redblue",
        "domainMid": 0,
        "clamp": true
      }
    },
    "opacity": {
      "condition": {"param": "stateSelect", "value": 1.0},
      "value": 0.6
    },
    "tooltip": [
      {"field": "state", "type": "nominal", "title": "State"},
      {"field": "year", "type": "quantitative", "title": "Year"},
      {"field": "income_median", "type": "quantitative", "title": "Median (RM)", "format": ",.0f"},
      {"field": "income_mean", "type": "quantitative", "title": "Mean (RM)", "format": ",.0f"},
      {"field": "yoy_pct", "type": "quantitative", "title": "YoY (%)", "format": ".1f"}
    ]
  },
  "config": {
    "view": {"stroke": null},
    "axis": {"labelFontSize": 11, "titleFontSize": 12},
    "legend": {"labelFontSize": 11, "titleFontSize": 12}
  }
}